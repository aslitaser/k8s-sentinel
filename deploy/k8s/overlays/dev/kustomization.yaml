apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

# Dev: single replica, no PDB needed
replicas:
  - name: k8s-sentinel
    count: 1

patches:
  # Override all policy modes to "warn" â€” don't block anything in dev
  - target:
      kind: ConfigMap
      name: k8s-sentinel-config
    patch: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: k8s-sentinel-config
      data:
        policies.yaml: |
          listen_addr: "0.0.0.0:8443"
          tls_cert_path: "/certs/tls.crt"
          tls_key_path: "/certs/tls.key"
          metrics_addr: "0.0.0.0:9090"
          log_level: "debug"

          policies:
            enforce_resource_limits:
              enabled: true
              mode: warn
              max_cpu_millicores: 4000
              max_memory_mb: 8192
              inject_defaults: true
              default_cpu_request: "100m"
              default_cpu_limit: "500m"
              default_memory_request: "128Mi"
              default_memory_limit: "512Mi"

            allowed_registries:
              enabled: true
              mode: warn
              registries:
                - "gcr.io/myproject"
                - "docker.io/library"
                - "us-docker.pkg.dev/myproject/images"
              allow_latest_tag: true

            required_labels:
              enabled: true
              mode: warn
              labels:
                - key: "app.kubernetes.io/name"
                - key: "app.kubernetes.io/version"
                  pattern: "^v?\\d+\\.\\d+\\.\\d+.*$"
                - key: "app.kubernetes.io/managed-by"

            topology_spread:
              enabled: false
              mode: warn
              max_skew: 1
              topology_key: "topology.kubernetes.io/zone"
              when_unsatisfiable: "ScheduleAnyway"
              inject_if_missing: false

  - target:
      kind: Deployment
      name: k8s-sentinel
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: k8s-sentinel
      spec:
        template:
          spec:
            containers:
              - name: k8s-sentinel
                imagePullPolicy: IfNotPresent
  - target:
      kind: PodDisruptionBudget
      name: k8s-sentinel
    patch: |
      $patch: delete
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: k8s-sentinel
